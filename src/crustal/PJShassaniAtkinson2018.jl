# Implementation of the Hassani & Atkinson adaptable GMM

# log10Y = F_E + F_kappa + F_Z + F_gamma + F_S + C

using Plots
pyplot()

using Interpolations

function interp1(xpt, ypt, x; method="linear", extrapvalue=nothing)

    if extrapvalue == nothing
        y = zeros(x)
        idx = trues(x)
    else
        y = extrapvalue*ones(x)
        idx = (x .>= xpt[1]) .& (x .<= xpt[end])
    end

    if method == "linear"
        intf = interpolate((xpt,), ypt, Gridded(Linear()))
        y[idx] = intf[x[idx]]

    elseif method == "cubic"
        itp = interpolate(ypt, BSpline(Cubic(Natural())), OnGrid())
        intf = scale(itp, xpt)
        y[idx] = [intf[xi] for xi in x[idx]]
    end

    return y
end


function PJSgetCoefficientIndex(T)
    freq = [ -1.0, Inf, 0.1, 0.125892541, 0.158489319, 0.199526231, 0.251188643, 0.316227766, 0.398107171, 0.501187234, 0.630957344, 0.794328235, 1.0, 1.258925412, 1.584893192, 1.995262315, 2.511886432, 3.16227766, 3.981071706, 5.011872336, 6.309573445, 7.943282347, 10.0, 12.58925412, 15.84893192, 19.95262315, 25.11886432, 31.6227766, 39.81071706, 50.11872336, 63.09573445, 79.43282347, 100.0 ]
    periods = 1./freq

    # if the requested period is greater than 10 seconds, return the 10 second response
    T = (T > 10.0) ? 10.0 : T

    if isapprox(T, -1.0) # PGV case (return coefficients at index 1)
        idx = (1,1)
        interp = false
    elseif isapprox(T, 0.0) || T < 0.01 # PGA case (return coefficients at index 2)
        idx = (2,2)
        interp = false
    else
        vidx = find(isapprox.(periods, T) .== true)
        if length(vidx) == 1 # have a single period
            idx = (vidx[1], vidx[1])
            interp = false
        else # will need to interpolate
            Tlo = maximum(periods[periods.<T])
            Thi = minimum(periods[periods.>T])
            idx = (find(periods.==Tlo)[1], find(periods.==Thi)[1])
            interp = true
        end
    end
    return (idx, interp)
end

out = PJSgetCoefficientIndex(20)
out[1]
out[2]

#periods[out[1][1]]
#periods[out[1][2]]

type PJScoefs
    f::Float64
    T::Float64
    Mh::Float64
    e0::Float64
    e1::Float64
    e2::Float64
    e3::Float64
    b3::Float64
    b4::Float64
    g1_0::Float64
    g1_1::Float64
    g1_2::Float64
    g1_3::Float64
    g1_4::Float64
    g2_0::Float64
    g2_1::Float64
    g2_2::Float64
    g2_3::Float64
    g2_4::Float64
    d1_0_0::Float64
    d1_0_1::Float64
    d1_0_2::Float64
    d1_1_0::Float64
    d1_1_1::Float64
    d1_1_2::Float64
    d1_2_0::Float64
    d1_2_1::Float64
    d1_2_2::Float64
    d1_3_0::Float64
    d1_3_1::Float64
    d1_3_2::Float64
    d2_0_0::Float64
    d2_0_1::Float64
    d2_0_2::Float64
    d2_1_0::Float64
    d2_1_1::Float64
    d2_1_2::Float64
    d2_2_0::Float64
    d2_2_1::Float64
    d2_2_2::Float64
    d2_3_0::Float64
    d2_3_1::Float64
    d2_3_2::Float64
    d3_0_0::Float64
    d3_0_1::Float64
    d3_0_2::Float64
    d3_1_0::Float64
    d3_1_1::Float64
    d3_1_2::Float64
    d3_2_0::Float64
    d3_2_1::Float64
    d3_2_2::Float64
    d3_3_0::Float64
    d3_3_1::Float64
    d3_3_2::Float64
    d4_0_0::Float64
    d4_0_1::Float64
    d4_0_2::Float64
    d4_1_0::Float64
    d4_1_1::Float64
    d4_1_2::Float64
    d4_2_0::Float64
    d4_2_1::Float64
    d4_2_2::Float64
    d4_3_0::Float64
    d4_3_1::Float64
    d4_3_2::Float64
    γCalifornia::Float64
end

type PJSgeometricCoefs
    Rt::Float64
    b1::Float64
    b2::Float64
end

cg = PJSgeometricCoefs(50.0, -1.3, -0.5)
cg.Rt
cg.b1
cg.b2


function PJSgetCoefficients(idx)
    # define all of the coefficients
    freq = [ -1.0, Inf, 0.1, 0.125892541, 0.158489319, 0.199526231, 0.251188643, 0.316227766, 0.398107171, 0.501187234, 0.630957344, 0.794328235, 1.0, 1.258925412, 1.584893192, 1.995262315, 2.511886432, 3.16227766, 3.981071706, 5.011872336, 6.309573445, 7.943282347, 10.0, 12.58925412, 15.84893192, 19.95262315, 25.11886432, 31.6227766, 39.81071706, 50.11872336, 63.09573445, 79.43282347, 100.0 ]
    Mh = [ 8.8, 7.4, 7.45, 7.45, 7.4, 7.4, 7.35, 7.25, 7.2, 7.05, 7, 7.7, 7.4, 7.1, 6.8, 6.45, 6.2, 5.9, 5.75, 5.55, 5.5, 5.7, 5.9, 6.1, 6.85, 7.4, 8.1, 8.25, 8.95, 7.8, 7.5, 7.4, 7.15 ]
    e0 = [ 3.30208327, 4.373758068, 2.415006866, 2.591716933, 2.714583716, 2.88639799, 3.006876941, 3.074443689, 3.157606266, 3.204996557, 3.28577343, 3.654548407, 3.616429106, 3.571361991, 3.525568083, 3.449898462, 3.434472694, 3.39048159, 3.402405632, 3.392360579, 3.449761862, 3.595868656, 3.730631226, 3.868473972, 4.185355567, 4.429340924, 4.7102513, 4.804222981, 5.065654626, 4.755608296, 4.69912519, 4.697753586, 4.645142068 ]
    e1 = [ 0.438969197, 0.330007551, 0.976952849, 0.94723293, 0.913692062, 0.876170157, 0.837485391, 0.791682106, 0.718287066, 0.68673092, 0.609733818, 0.357599843, 0.359772626, 0.35652637, 0.361541062, 0.360743896, 0.354711496, 0.361005407, 0.359494885, 0.360299708, 0.352613435, 0.345737412, 0.341230002, 0.335578166, 0.326789586, 0.316611636, 0.307482831, 0.306664806, 0.296376597, 0.326938489, 0.336016402, 0.338482609, 0.344041276 ]
    e2 = [ -0.016723514, -0.009395075, -0.009454726, -0.01550499, -0.022484062, -0.03008096, -0.038157852, -0.048499264, -0.063313554, -0.07302709, -0.088578297, -0.105717911, -0.111925506, -0.11932417, -0.125200215, -0.135907247, -0.142167139, -0.1495338, -0.14482905, -0.14134425, -0.125393375, -0.091198369, -0.065869952, -0.048585162, -0.027670026, -0.021092814, -0.015835705, -0.013746637, -0.011928199, -0.010314344, -0.008937222, -0.008247822, -0.008155172 ]
    e3 = [ 0.414635056, 0.301533332, 0.613067542, 0.574794763, 0.542441872, 0.494472907, 0.456823509, 0.439448184, 0.422258717, 0.402156533, 0.384104477, 0.356531999, 0.359494555, 0.35702375, 0.360024561, 0.363228092, 0.359264445, 0.360279041, 0.357607348, 0.357916873, 0.352509655, 0.345537122, 0.34086406, 0.33553826, 0.326381594, 0.316535782, 0.307325291, 0.307839983, 0.29693739, 0.303386093, 0.306043905, 0.304900059, 0.305646739 ]
    b3 = [ -0.441446835, -0.456482013, -0.420259684, -0.405060611, -0.389733985, -0.368893182, -0.352956485, -0.336265555, -0.32433101, -0.300173094, -0.289540692, -0.278220656, -0.266181088, -0.264977379, -0.265047241, -0.28125334, -0.296597777, -0.308495634, -0.307782371, -0.326185003, -0.338642055, -0.341759491, -0.352445431, -0.369374453, -0.381635363, -0.387204222, -0.394259793, -0.407490085, -0.409808796, -0.420904887, -0.428188954, -0.433463118, -0.432123999 ]
    b4 = [ 0.039412357, 0.038249908, 0.049815063, 0.047234768, 0.044643091, 0.040976001, 0.037906794, 0.034756654, 0.032269761, 0.027286904, 0.024598988, 0.022527605, 0.020132137, 0.018826848, 0.018486728, 0.020158025, 0.021226076, 0.022341086, 0.02187722, 0.024365045, 0.025211426, 0.025198759, 0.026525009, 0.028352765, 0.030181543, 0.030295798, 0.03110088, 0.032677832, 0.033118614, 0.034355288, 0.035137303, 0.035953803, 0.035279598 ]
    g1_0 = [ 0.444250614, 0.709663325, -8.935421934, -7.967855354, -6.070843573, -3.889661928, -1.212860407, 1.70040969, 4.471237757, 6.500900549, 7.648530693, 7.368131062, 5.949046632, 3.42518494, 0.526480146, -2.478111982, -4.81543898, -6.541655967, -7.161936971, -6.701838602, -5.461328894, -3.703105706, -1.574872821, 0.234847202, 1.501367986, 2.21569742, 2.42576188, 2.277944354, 2.153913814, 1.912143395, 1.714652088, 1.554223891, 1.472415543 ]
    g1_1 = [ 0.056972238, -0.038391861, 7.144835427, 6.53620996, 5.214049008, 3.647243125, 1.659951431, -0.551013273, -2.731618784, -4.413971895, -5.478710891, -5.49997407, -4.671327305, -2.99132466, -0.970881597, 1.203995619, 2.969329122, 4.347029655, 4.975700188, 4.842848118, 4.154378482, 3.066793605, 1.682296287, 0.470479076, -0.38562489, -0.886226512, -1.048628208, -0.964799418, -0.892759185, -0.751222247, -0.642699506, -0.561607534, -0.541245476 ]
    g1_2 = [ 0.00364377, 0.013080821, -1.952402824, -1.828752718, -1.513382625, -1.123763816, -0.609562804, -0.024090121, 0.575555267, 1.0596086, 1.393183818, 1.459252663, 1.304610712, 0.921436876, 0.435756533, -0.10789424, -0.563840001, -0.933850654, -1.125764738, -1.128497523, -0.991765532, -0.749184783, -0.426389576, -0.137620428, 0.067906688, 0.19112932, 0.232493651, 0.213692857, 0.198230538, 0.167414015, 0.145152547, 0.131399907, 0.133779213 ]
    g1_3 = [ -0.00404582, -0.001137964, 0.221535124, 0.21255848, 0.182276733, 0.142588115, 0.087637182, 0.023559107, -0.044608624, -0.101708256, -0.143505558, -0.156521623, -0.145670012, -0.109220135, -0.060272147, -0.00335199, 0.045648218, 0.0866261, 0.109685581, 0.11282087, 0.101167973, 0.077858571, 0.045587433, 0.016237335, -0.004808796, -0.017642758, -0.021998522, -0.0200645, -0.018626873, -0.015673508, -0.013649204, -0.012766021, -0.013606461 ]
    g1_4 = [ 0.000353005, 2.3783E-05, -0.008812728, -0.008649087, -0.007654299, -0.006238847, -0.004167229, -0.001691644, 0.00104249, 0.003403682, 0.005210428, 0.005909668, 0.005690146, 0.004449906, 0.002677732, 0.000540705, -0.001338694, -0.002949142, -0.003908082, -0.004109379, -0.003747047, -0.002928438, -0.001753634, -0.000671954, 0.00010993, 0.000592351, 0.000756339, 0.000681448, 0.000633041, 0.000527754, 0.0004587, 0.000443372, 0.000491618 ]
    g2_0 = [ -0.094203493, -0.032384772, 1.461981236, 1.149223949, 0.699128647, 0.207080336, -0.330958038, -0.85697877, -1.296131365, -1.529643643, -1.556335247, -1.284003433, -0.807547691, -0.149512646, 0.51134904, 1.121871309, 1.511291169, 1.717463815, 1.64732247, 1.341265135, 0.89082866, 0.381196376, -0.151856006, -0.55047986, -0.780201986, -0.856307546, -0.811617033, -0.68221201, -0.571979269, -0.447888265, -0.349980302, -0.264750416, -0.222277352 ]
    g2_1 = [ 0.053343461, 0.019043212, -1.163288972, -0.944490534, -0.617005313, -0.25139394, 0.159703154, 0.570436548, 0.930304209, 1.144110405, 1.207240393, 1.045680821, 0.726202296, 0.260357996, -0.224277741, -0.689355007, -1.006867828, -1.199601494, -1.197509189, -1.022197141, -0.737590873, -0.399304218, -0.032760031, 0.252178841, 0.424442091, 0.494428259, 0.481301579, 0.407086072, 0.342742315, 0.269463519, 0.213120022, 0.165203314, 0.146276196 ]
    g2_2 = [ -0.014163359, -0.004516616, 0.325559932, 0.272771051, 0.189848482, 0.094773467, -0.015464143, -0.127920488, -0.231209005, -0.298232955, -0.326812703, -0.296040423, -0.222759368, -0.108514601, 0.014578301, 0.136977271, 0.224830324, 0.282950791, 0.293010899, 0.258560368, 0.195269443, 0.116175645, 0.02775096, -0.042792223, -0.086695294, -0.106361245, -0.105651727, -0.089572785, -0.075675215, -0.059636065, -0.047605921, -0.037932404, -0.035352696 ]
    g2_3 = [ 0.001918592, 0.000374576, -0.038128477, -0.032947637, -0.024314563, -0.014072491, -0.001792878, 0.010975152, 0.023230682, 0.031731559, 0.036130155, 0.033957009, 0.027034165, 0.015352819, 0.002318575, -0.011064538, -0.021029868, -0.0280148, -0.030006962, -0.02718553, -0.021185626, -0.013321379, -0.004278216, 0.003069324, 0.007740373, 0.009952747, 0.010041654, 0.0084928, 0.007182719, 0.005644097, 0.004515896, 0.003683217, 0.003579685 ]
    g2_4 = [ -0.000100241, -9.33799E-06, 0.001573175, 0.001397513, 0.001083307, 0.000694368, 0.000211241, -0.000300133, -0.000811295, -0.001184289, -0.001401341, -0.001358841, -0.001128145, -0.000701774, -0.000209252, 0.000311248, 0.000709735, 0.001000957, 0.001105591, 0.001023392, 0.000816388, 0.000532863, 0.00019837, -7.6988E-05, -0.000255126, -0.000342533, -0.000349965, -0.000294393, -0.000249038, -0.000194439, -0.000155199, -0.000129329, -0.000130131 ]
    d1_0_0 = [ -40.82616422, -51.09871752, -21.11656517, -23.25539951, -24.77411026, -25.70577533, -26.26426838, -22.7410655, -21.02565365, -20.19606399, -15.62677559, -8.939957851, -7.325604879, -9.791212818, -13.54085066, -11.81240765, -11.1714289, -12.45719828, -14.44538871, -23.66034434, -24.17712706, -57.66140859, -68.45848086, -7.76364174, 51.16664069, 27.0850641, -10.32968081, -36.45434724, -48.47972191, -42.82773258, -33.84308662, -36.82852226, -41.01079828 ]
    d1_0_1 = [ 40.11303926, 32.57879641, 26.95059566, 27.26917442, 26.22452614, 24.07648705, 23.77125245, 22.41132328, 20.91468139, 21.60558458, 19.50805936, 14.67468508, 13.61400192, 13.76999145, 17.05577575, 13.81038108, 13.42475967, 13.45260356, 18.49666713, 26.46403108, 31.50574867, 52.21015318, 28.82968853, -66.14960564, -130.6664837, -63.71909864, 9.721835119, 50.7470671, 55.77850003, 41.10758824, 21.85277173, 19.56925181, 20.9848341 ]
    d1_0_2 = [ -5.10212856, -0.602711308, -4.295477502, -4.355136306, -4.200479494, -3.870359364, -4.060054313, -4.096293297, -3.657589619, -3.967159493, -3.560531414, -2.505880466, -2.386625795, -2.058022568, -2.804665389, -2.093802847, -2.312675979, -2.296075834, -3.731558518, -5.426108448, -6.301201728, -6.534008553, 4.605561837, 26.95231631, 34.96702348, 13.83425931, -2.428971573, -7.854933855, -4.013399395, 1.767005633, 6.415626556, 6.125909393, 4.332932156 ]
    d1_1_0 = [ 155.2523127, 193.3769389, 74.84082081, 83.88259335, 90.85637966, 96.62991305, 100.4723015, 86.63212006, 80.2541588, 76.95588223, 56.98523367, 28.48766009, 20.4853895, 28.9681774, 41.25882949, 31.44477794, 23.82854524, 25.04191898, 24.54814438, 55.79123052, 42.85664695, 177.243465, 237.8280303, 8.975810321, -210.7195192, -111.853248, 43.88353737, 150.7810896, 203.1744409, 175.9994852, 132.5335446, 133.7996869, 143.7259148 ]
    d1_1_1 = [ -182.3686804, -154.536656, -115.4589238, -116.9256606, -112.9422844, -105.0203224, -103.6463082, -97.02041071, -89.92996233, -91.93713302, -81.27241316, -60.53372807, -55.64843493, -57.06426916, -70.29492787, -57.8948328, -55.21296605, -56.59069486, -76.14114363, -112.0606207, -131.4421294, -234.3683114, -164.2666966, 219.6493166, 498.9518852, 249.1446647, -42.55484893, -212.7678868, -245.4657544, -195.1960147, -119.6575221, -108.9284408, -112.5739642 ]
    d1_1_2 = [ 27.0333494, 8.970141012, 19.65299651, 19.89613285, 19.29735904, 18.09021794, 18.81428233, 18.79413519, 16.83869256, 18.00910228, 15.94963866, 11.44717733, 10.84516973, 9.664295462, 12.71025717, 9.877971488, 10.51249215, 10.66513194, 16.60387976, 24.63696364, 28.59015295, 33.47992572, -8.836443977, -103.3790756, -142.5647839, -59.28852757, 10.08131492, 36.87242934, 25.9385381, 4.99520665, -14.28942514, -14.57942774, -8.798757262 ]
    d1_2_0 = [ -196.6717543, -246.3770135, -88.39743109, -100.7237169, -110.881403, -120.7036701, -127.6859292, -110.2342525, -102.867295, -99.17849019, -71.94657122, -33.74954011, -22.68385128, -33.50941375, -48.22678998, -33.69996272, -20.51667641, -20.42926146, -11.97599082, -47.62685519, -12.53682264, -183.2380501, -274.7648414, 15.40579894, 294.3730887, 168.949914, -39.43588547, -186.1677314, -266.7082108, -233.8443864, -178.4664241, -175.1080288, -185.5027173 ]
    d1_2_1 = [ 258.2107953, 224.30934, 157.3435337, 159.5123687, 154.63744, 145.0266968, 143.1610935, 133.3650477, 122.9823995, 124.8886043, 108.4182979, 79.83956243, 72.72481578, 75.20202382, 92.59234405, 76.33600548, 71.26649274, 74.08343566, 97.21479112, 146.5180597, 166.6237148, 322.7072974, 260.0220514, -240.4576359, -626.3972936, -319.851084, 56.80979308, 284.265373, 340.0759449, 282.7603313, 186.8869255, 171.4375897, 174.2625858 ]
    d1_2_2 = [ -42.36533011, -19.05603874, -28.13166879, -28.45080159, -27.70305064, -26.22823672, -27.13282186, -26.94086077, -24.16386446, -25.62569091, -22.43633834, -16.27244873, -15.35825407, -13.94709827, -18.04548829, -14.27342633, -14.85675598, -15.33203293, -23.16910142, -35.04115588, -40.38678598, -52.18962703, -0.933937364, 127.1045681, 186.5756079, 80.3566298, -13.52854792, -53.19093358, -43.5920265, -18.60477507, 6.835534481, 8.45332605, 2.145698024 ]
    d1_3_0 = [ 82.35747907, 103.8674069, 34.54679284, 39.95954233, 44.64378775, 49.61010906, 53.27858563, 46.03411303, 43.21519113, 41.85493741, 29.78874076, 13.110558, 8.102878277, 12.61161663, 18.39272956, 11.43524428, 4.629920615, 4.09878749, -2.324617323, 11.28083515, -9.725772055, 62.32352219, 107.1387613, -12.57263406, -129.806949, -78.75859197, 10.66244052, 75.38242286, 113.9342895, 100.4408356, 77.88498273, 74.84459691, 78.79319946 ]
    d1_3_1 = [ -116.4544082, -102.8628006, -69.08875964, -70.12834076, -68.19722515, -64.36030502, -63.57275039, -59.0219141, -54.20406022, -54.7932638, -46.83040192, -34.09395131, -30.7620665, -31.97463759, -39.45850862, -32.28156182, -29.46908292, -30.94440198, -39.55257566, -60.88857686, -66.40336448, -140.8212429, -125.3748478, 86.73533288, 258.8850624, 134.8937079, -23.90267304, -122.5808344, -151.0624029, -129.2075056, -89.60217543, -82.54352198, -83.128703 ]
    d1_3_2 = [ 20.53760931, 10.76740358, 12.8339016, 12.97251524, 12.66950627, 12.0710777, 12.44421938, 12.30784277, 11.03927224, 11.64187765, 10.09235596, 7.363532198, 6.924623207, 6.36002395, 8.170881832, 6.499639548, 6.663017642, 6.964705999, 10.3024062, 15.83799393, 18.06028181, 25.32930981, 5.31707408, -50.71787974, -79.26211447, -35.05792894, 5.852526691, 24.24241348, 21.79371016, 11.9279871, 1.106684051, 0.054734672, 2.380508727 ]
    d2_0_0 = [ -31.55892707, -44.5620634, -14.30934443, -15.58486327, -16.39906285, -16.84009004, -17.75177443, -15.26397215, -14.05882356, -14.23764627, -11.76841339, -6.823298637, -6.600019837, -8.121295776, -10.56203471, -9.513157631, -8.784640041, -8.496994408, -9.917547545, -16.82825388, -17.00013963, -42.11018414, -49.29738025, 0.064603758, 46.6918844, 23.63797669, -11.52386389, -31.5145158, -42.83828261, -36.36228874, -28.5771732, -31.17227997, -35.56512963 ]
    d2_0_1 = [ 36.87477402, 38.70827928, 23.0803642, 23.22751562, 22.49929621, 21.15905312, 21.96525998, 21.42552142, 20.33817977, 21.45830017, 20.48507503, 16.34918264, 15.88976799, 14.81073504, 16.11567825, 13.27323045, 12.53211592, 11.19318632, 15.16828125, 21.44725894, 26.15999155, 41.04474743, 21.63119099, -52.77958336, -99.66819167, -38.46388464, 27.27766858, 58.50024312, 60.84121935, 45.18398498, 27.54783805, 25.35133399, 27.79777636 ]
    d2_0_2 = [ -5.739549233, -3.922374087, -4.515178185, -4.548619512, -4.454104633, -4.272283011, -4.627096242, -4.717231925, -4.315138665, -4.630732686, -4.373143717, -3.37825152, -3.329883492, -2.766637901, -3.036012741, -2.411077394, -2.431217646, -2.133386624, -3.258594313, -4.639739998, -5.545690807, -5.388707549, 3.518638058, 20.63067488, 25.41800218, 6.920800415, -7.08451916, -10.43003117, -6.458254246, -0.914572804, 3.0405208, 2.531652189, 0.505080395 ]
    d2_1_0 = [ 125.2777711, 176.725188, 51.06597526, 56.44950873, 60.31211484, 63.43958636, 68.11627649, 58.10943261, 53.57885669, 54.20495405, 43.01847734, 21.94558556, 20.22060686, 25.53242584, 33.66213222, 27.75650655, 21.43195228, 17.89276471, 17.60953567, 41.81007441, 31.63253209, 133.9449721, 177.9833175, -6.928644546, -179.9661292, -85.74778779, 59.61250102, 140.0477465, 188.7203162, 157.3334082, 118.5562095, 118.7523253, 130.2847004 ]
    d2_1_1 = [ -161.3065178, -170.7934709, -94.91240154, -95.59807593, -92.85700029, -87.99189178, -91.17881826, -88.20137418, -83.2808085, -87.44702441, -82.17405868, -64.78842943, -62.91742846, -59.41312162, -64.89674881, -54.19461193, -50.4738737, -46.10700337, -61.52961818, -89.72801513, -107.9725844, -182.9370311, -122.6159569, 179.8937466, 386.4359651, 155.8694393, -107.0341308, -237.7623187, -259.2502198, -204.0219745, -134.3070026, -123.338464, -131.1409419 ]
    d2_1_2 = [ 27.87404496, 21.015529, 19.60507976, 19.73912477, 19.39160066, 18.75898253, 20.18377749, 20.44371699, 18.72975178, 19.98039776, 18.66832572, 14.4731677, 14.24875983, 12.08084212, 13.20112919, 10.69990868, 10.60933924, 9.553985476, 14.22153343, 20.70470921, 24.72076585, 27.07809405, -7.061506931, -79.81869807, -104.6972771, -31.159347, 29.13406533, 46.97274995, 35.00711509, 14.52481236, -2.241058286, -1.805441899, 4.976748558 ]
    d2_2_0 = [ -163.4368686, -230.9326524, -60.43998464, -67.76977361, -73.53835916, -79.10429217, -86.46733205, -73.57668196, -68.27080703, -69.38739215, -53.78042075, -25.43701977, -22.94835026, -29.81415997, -39.69119519, -30.84739387, -20.20274166, -14.46653211, -8.005211849, -35.87649123, -8.170102668, -138.7571681, -206.8330558, 26.55656097, 245.4105149, 125.0726822, -69.92043473, -180.7645677, -255.7087779, -216.2043783, -166.1464289, -161.1733562, -173.6461343 ]
    d2_2_1 = [ 223.2664466, 237.8661601, 125.4898599, 126.5101496, 123.2074399, 117.3482961, 121.5217723, 116.8469477, 109.8605416, 115.040466, 106.5984889, 83.01432309, 80.52350896, 76.69641554, 84.2066324, 70.40883152, 64.49717963, 59.58984358, 77.8930126, 116.5908958, 136.316367, 251.1195173, 194.0177681, -201.9567967, -490.9231981, -205.7601512, 135.7820299, 311.4806215, 352.33067, 287.5455973, 198.5478127, 182.1538054, 190.4355184 ]
    d2_2_2 = [ -41.39183307, -33.08371918, -26.99314009, -27.16474612, -26.75782577, -26.01116742, -27.87898989, -28.12459271, -25.776517, -27.41285957, -25.3827672, -19.70018658, -19.3913915, -16.65730954, -18.22282841, -14.89038571, -14.60568071, -13.39919136, -19.57325096, -29.10672293, -34.51801076, -41.73065122, 0.062549919, 99.04105511, 138.3702406, 43.92377057, -38.27950151, -65.70920829, -54.31158305, -29.45817952, -7.035860772, -6.194116473, -13.86390221 ]
    d2_3_0 = [ 69.90315748, 99.13645948, 23.59751679, 26.81240843, 29.52227085, 32.39067233, 35.97541665, 30.52958921, 28.47760694, 29.06591503, 22.02936259, 9.622979003, 8.442673537, 11.33868157, 15.29895398, 11.00124522, 5.59516093, 2.838653998, -2.102767732, 8.681615567, -7.964176648, 47.42590542, 81.2412856, -14.74867015, -106.5622354, -57.31336162, 26.64627189, 75.6530222, 111.6496866, 95.01570153, 74.45473671, 70.66515122, 75.47655051 ]
    d2_3_1 = [ -99.25266024, -106.274886, -53.82205194, -54.31465044, -53.02948421, -50.69300802, -52.5004113, -50.25200031, -47.08145276, -49.22490833, -45.04916786, -34.66649214, -33.57014222, -32.16141529, -35.52085971, -29.52526975, -26.55997374, -24.67758463, -31.52235355, -48.2989493, -54.29458913, -109.4540239, -93.65982242, 74.69223177, 204.8012162, 88.71207405, -56.06382083, -132.580092, -154.5931007, -129.2263384, -92.29267796, -84.60181488, -87.5347799 ]
    d2_3_2 = [ 19.35022146, 16.0786467, 11.94872521, 12.02143147, 11.8686413, 11.57227804, 12.37451198, 12.45083996, 11.40888683, 12.11352868, 11.13009578, 8.6368222, 8.501097177, 7.365445564, 8.087503699, 6.614863277, 6.43641502, 5.981079269, 8.616295014, 13.05185868, 15.31887822, 20.11269377, 3.599961581, -39.89035244, -59.31781746, -19.79489715, 16.24512579, 29.25167327, 25.89876709, 15.94045116, 6.313615825, 5.52923446, 8.453462968 ]
    d3_0_0 = [ -10.37628001, -16.42243782, -4.333707009, -4.678472027, -4.882647182, -4.974983854, -5.401081415, -4.618710154, -4.22032663, -4.45096442, -3.820417822, -2.230057101, -2.399850894, -2.735424909, -3.348490735, -3.121737955, -2.889597187, -2.575011896, -2.99651921, -5.288994115, -5.341652215, -13.48378551, -15.60012415, 1.371377675, 16.99465097, 8.194185629, -5.065915414, -11.52124038, -15.83658074, -13.04105846, -10.40912883, -11.28117808, -13.14574684 ]
    d3_0_1 = [ 13.05140093, 15.84793127, 7.932060254, 7.958404682, 7.738960719, 7.359397932, 7.859048174, 7.768048443, 7.384425649, 7.879438456, 7.664230776, 6.227992427, 6.205665285, 5.545805701, 5.651545503, 4.754601397, 4.488225071, 3.845385796, 5.146787157, 7.319695659, 9.099536553, 13.75838338, 6.982887685, -17.93868355, -32.64270223, -10.0556218, 13.83250985, 23.81578277, 23.98178504, 17.52698728, 11.09832454, 10.2045188, 11.60167077 ]
    d3_0_2 = [ -2.256508542, -2.16864161, -1.740814706, -1.748796072, -1.72373877, -1.677937422, -1.842006886, -1.881402923, -1.728543227, -1.854116008, -1.778514723, -1.418813691, -1.426239821, -1.166748674, -1.17536018, -0.982265751, -0.964384637, -0.820947882, -1.183173201, -1.666209527, -2.018010489, -1.881790292, 1.149203842, 6.785619116, 8.000598193, 1.357384575, -3.6007584, -4.438531879, -2.82878495, -0.71359723, 0.62375221, 0.356264102, -0.552587158 ]
    d3_1_0 = [ 41.86773816, 65.99773738, 15.46959498, 16.92335552, 17.9239199, 18.69992146, 20.7060623, 17.50888359, 16.00434712, 16.86974796, 13.91816008, 7.139707281, 7.6268407, 8.765383814, 10.76634223, 9.388295416, 7.43523301, 5.531501296, 5.366689315, 13.58268008, 10.34776843, 43.87074107, 57.79051204, -5.622000186, -63.51458036, -27.7941444, 26.70171411, 52.12625562, 70.43915247, 56.7766408, 43.18050916, 42.75430218, 48.06821845 ]
    d3_1_1 = [ -56.05502765, -67.97303864, -31.87511836, -32.00273279, -31.18663569, -29.82594477, -31.83058382, -31.21501655, -29.5510452, -31.46819434, -30.22179971, -24.23942462, -24.23863632, -21.8911747, -22.43013458, -19.08883117, -17.80497932, -15.57843803, -20.63878464, -30.35173109, -37.28379641, -61.00801731, -39.46235032, 62.27489381, 127.9964174, 42.43563619, -53.57128432, -95.73062917, -101.059928, -77.87553124, -52.29786271, -47.64139578, -52.45110242 ]
    d3_1_2 = [ 10.53033171, 10.38551444, 7.352614686, 7.384072821, 7.29702808, 7.14580414, 7.810705829, 7.940035739, 7.303436971, 7.806779429, 7.420628921, 5.910868141, 5.947099833, 4.931565704, 4.978746102, 4.203363366, 4.085591014, 3.558697759, 5.071155439, 7.324407294, 8.875047313, 9.304196709, -2.385280999, -26.43558001, -33.23864627, -6.686058335, 14.80410922, 19.74526774, 14.71206634, 6.778782328, 0.974449582, 1.35097042, 4.478831273 ]
    d3_2_0 = [ -55.19259392, -87.0701819, -18.26155628, -20.23954891, -21.76915628, -23.2146846, -26.20189728, -22.02466466, -20.24600429, -21.43177714, -17.22854611, -8.089197645, -8.706471421, -10.18637217, -12.60915783, -10.46081735, -7.148481346, -4.34562185, -2.118150033, -11.67017652, -2.606959072, -45.57978669, -67.51014999, 12.30839936, 85.31536448, 39.56707037, -33.68348401, -68.7772422, -96.98930673, -79.37728148, -61.61140175, -58.87623583, -64.76594364 ]
    d3_2_1 = [ 76.69601424, 93.03343486, 41.39962959, 41.59418831, 40.62527648, 38.99419456, 41.63288843, 40.586946, 38.2936647, 40.75546362, 38.68887579, 30.63242155, 30.72663129, 27.9422098, 28.80137052, 24.5222316, 22.53444967, 19.90648199, 25.92410652, 39.24537445, 46.9362692, 83.56968226, 62.45868669, -71.11028187, -163.9914945, -57.71111646, 67.57351604, 124.5279048, 136.457275, 108.7930409, 75.98789848, 68.85424305, 74.38703193 ]
    d3_2_2 = [ -15.23846165, -15.32973688, -9.915528055, -9.954634255, -9.860528095, -9.688466877, -10.56744048, -10.71139544, -9.856116395, -10.52175365, -9.924872638, -7.888199556, -7.950366255, -6.652380528, -6.748344179, -5.710878828, -5.513494438, -4.882162671, -6.892426963, -10.19441779, -12.28417854, -14.20529997, 0.211002391, 33.03583032, 44.27922555, 10.03808632, -19.42277988, -27.35987488, -22.33254425, -12.58514323, -4.711911762, -4.578900124, -8.207449614 ]
    d3_3_0 = [ 23.77607016, 37.63866242, 7.099147776, 7.966197538, 8.696839679, 9.454930453, 10.86005247, 9.075047828, 8.382355052, 8.912003227, 6.988036647, 2.980570352, 3.229578122, 3.856513646, 4.830425157, 3.748709524, 2.060159196, 0.78274037, -0.886376819, 2.853302058, -2.6437437, 15.66229922, 26.67914453, -6.096360145, -36.68322673, -17.92206769, 13.70415991, 29.22893668, 42.81205709, 35.28963806, 27.94680697, 26.08819793, 28.38896685 ]
    d3_3_1 = [ -33.83271306, -41.09486034, -17.50332759, -17.59949584, -17.22899047, -16.57778833, -17.71816122, -17.19378271, -16.17594356, -17.22069117, -16.17632058, -12.65006813, -12.72085817, -11.6200045, -12.05370092, -10.20083454, -9.219451867, -8.173392382, -10.42874037, -16.21263656, -18.68515741, -36.39955024, -30.19115884, 26.73093389, 68.86248145, 25.44934151, -27.87368752, -52.75741697, -59.63817923, -48.6391063, -34.9786896, -31.57417882, -33.7045319 ]
    d3_3_2 = [ 6.996974483, 7.148395589, 4.318338862, 4.334423281, 4.302810471, 4.235970695, 4.616052667, 4.670423394, 4.29706609, 4.586453303, 4.297892913, 3.407452788, 3.440593669, 2.896002099, 2.955280276, 2.494789418, 2.395702382, 2.145380972, 3.006621484, 4.540573567, 5.420392272, 6.807954071, 1.065238436, -13.4000889, -19.11771157, -4.743307445, 8.233201452, 12.08890927, 10.50309527, 6.556052291, 3.144502335, 2.895149146, 4.310521489 ]
    d4_0_0 = [ -1.229433431, -2.134041666, -0.486168912, -0.521559522, -0.541658424, -0.54859969, -0.611228347, -0.520072252, -0.471011516, -0.512949031, -0.449459372, -0.262856779, -0.304166127, -0.324788036, -0.376571715, -0.36355235, -0.339177334, -0.28749366, -0.332480371, -0.611268634, -0.620089538, -1.581489925, -1.812876912, 0.278993132, 2.163192303, 0.997066056, -0.74282663, -1.492252791, -2.064807992, -1.659777408, -1.350461248, -1.449796602, -1.715883617 ]
    d4_0_1 = [ 1.604051176, 2.150893431, 0.959649803, 0.961043011, 0.936974622, 0.896211213, 0.975706878, 0.97034697, 0.920306563, 0.990384831, 0.970761883, 0.794672789, 0.805238996, 0.698058908, 0.680626551, 0.584758242, 0.554542371, 0.467366146, 0.620140218, 0.893067071, 1.126990247, 1.661143295, 0.816534542, -2.198066373, -3.880007086, -0.96223293, 2.086029509, 3.23329695, 3.18420488, 2.280063408, 1.465127598, 1.33806748, 1.576222832 ]
    d4_0_2 = [ -0.296017448, -0.337012006, -0.226702079, -0.227409955, -0.225009335, -0.220551219, -0.24415235, -0.249365484, -0.229125602, -0.246373885, -0.237817402, -0.19281728, -0.196304727, -0.158691045, -0.152351087, -0.132423398, -0.128487099, -0.10876351, -0.150500844, -0.211357892, -0.257915055, -0.233865794, 0.137289781, 0.810584506, 0.920975872, 0.078462867, -0.542554951, -0.614189689, -0.391808802, -0.111624799, 0.046401263, 0.003661107, -0.132059939 ]
    d4_1_0 = [ 4.993481681, 8.618757631, 1.730713456, 1.879886887, 1.981140406, 2.054069908, 2.338044066, 1.961472005, 1.776009979, 1.93424518, 1.629298698, 0.833590764, 0.983222856, 1.044728674, 1.204459211, 1.102340198, 0.890425343, 0.618598547, 0.586776425, 1.60206291, 1.236342653, 5.224072633, 6.835187815, -0.973690882, -7.95435307, -3.249763109, 3.869186822, 6.757360826, 9.164869576, 7.17850873, 5.522434532, 5.403171915, 6.206072084 ]
    d4_1_1 = [ -6.816710646, -9.089596253, -3.800121785, -3.807685736, -3.719234447, -3.57432377, -3.894666576, -3.844431766, -3.633508927, -3.908464608, -3.788806718, -3.058636291, -3.119945459, -2.72670779, -2.672388024, -2.319097753, -2.174980749, -1.870106044, -2.46534851, -3.680130322, -4.595344058, -7.340904985, -4.612347051, 7.731893575, 15.34259078, 4.250549026, -8.046313232, -12.9297889, -13.3553053, -10.06801604, -6.807942164, -6.129093123, -6.977314096 ]
    d4_1_2 = [ 1.350201888, 1.542770572, 0.941413752, 0.944166231, 0.93638508, 0.922361477, 1.018347787, 1.03615093, 0.952912876, 1.022172862, 0.978539351, 0.790049355, 0.806391194, 0.657991852, 0.633988573, 0.553669519, 0.533643936, 0.46109469, 0.636599201, 0.919167094, 1.12395681, 1.143415259, -0.294438402, -3.174987625, -3.85320699, -0.47388849, 2.231617829, 2.71801631, 2.005714098, 0.942712887, 0.240612626, 0.310717286, 0.786462806 ]
    d4_2_0 = [ -6.609082033, -11.41668362, -2.034029454, -2.236969428, -2.394692669, -2.537028434, -2.948564712, -2.451768619, -2.2313731, -2.44076189, -1.999440843, -0.924593006, -1.12337042, -1.203448519, -1.393189962, -1.219100587, -0.85348092, -0.4657665, -0.184214385, -1.373910847, -0.31151976, -5.441877207, -8.019371757, 1.792854884, 10.57723168, 4.544392848, -5.039165932, -9.027904301, -12.7365278, -10.13783549, -7.9489982, -7.485634395, -8.387873606 ]
    d4_2_1 = [ 9.262414735, 12.32449014, 4.878348029, 4.890665506, 4.787192462, 4.613768577, 5.036197624, 4.942790342, 4.658170059, 5.014604561, 4.811047577, 3.831316962, 3.932133641, 3.453348809, 3.403240452, 2.952492606, 2.730190421, 2.367969326, 3.076553211, 4.741355746, 5.773783216, 10.04255178, 7.308278065, -8.934275388, -19.77975422, -5.964418711, 10.13653522, 16.76431725, 17.98759482, 14.02105365, 9.823775789, 8.768873344, 9.776758055 ]
    d4_2_2 = [ -1.924629722, -2.21323588, -1.253387618, -1.256707454, -1.249196492, -1.233765852, -1.361074241, -1.381728123, -1.271093697, -1.362830891, -1.295541052, -1.041745607, -1.066722058, -0.875747478, -0.848445821, -0.740247244, -0.710181258, -0.622808506, -0.857239989, -1.270200389, -1.546426606, -1.73447605, 0.048216507, 3.989349685, 5.165791423, 0.796484316, -2.928032158, -3.750697913, -3.018563691, -1.700232792, -0.734947895, -0.734349364, -1.2952752 ]
    d4_3_0 = [ 2.854701411, 4.950045904, 0.786412029, 0.875369651, 0.951699364, 1.027578004, 1.217732724, 1.003781575, 0.917647442, 1.008600431, 0.804228697, 0.332274427, 0.417680739, 0.451512989, 0.527027549, 0.43331553, 0.2452311, 0.07209907, -0.133498389, 0.336447261, -0.314798812, 1.878435156, 3.184592503, -0.841023651, -4.517737683, -2.041530287, 2.104843128, 3.868931783, 5.657376969, 4.538010097, 3.628393761, 3.333471731, 3.688341554 ]
    d4_3_1 = [ -4.066423139, -5.410115911, -2.042805816, -2.049251073, -2.010391036, -1.940914296, -2.123458724, -2.074601359, -1.950334384, -2.102643735, -1.998174143, -1.570612436, -1.620805599, -1.427376537, -1.414897942, -1.219534664, -1.109827424, -0.965106778, -1.230828197, -1.954443233, -2.297616021, -4.372726151, -3.538277842, 3.395967065, 8.345031458, 2.690323924, -4.183465962, -7.087304533, -7.850825288, -6.258265309, -4.505746133, -3.997333065, -4.397404994 ]
    d4_3_2 = [ 0.87437342, 1.012283062, 0.540367955, 0.54169086, 0.53963206, 0.533736922, 0.588934343, 0.59704828, 0.549199036, 0.589139092, 0.556679483, 0.445901298, 0.458069374, 0.377501083, 0.368027541, 0.319612865, 0.305440586, 0.270593613, 0.371402568, 0.562998143, 0.679679435, 0.828058414, 0.113794682, -1.62684216, -2.242844342, -0.40491617, 1.241439755, 1.651817559, 1.411862961, 0.873886927, 0.45203916, 0.42295562, 0.644873817 ]
    γCalifornia = [ -0.0029864, -0.0043865, -0.0009496, -0.0010052, -0.0011408, -0.00132, -0.0013395, -0.0012876, -0.0013304, -0.0015094, -0.0016821, -0.0018966, -0.0021188, -0.0023384, -0.0026099, -0.0029144, -0.0032389, -0.0036465, -0.0041191, -0.0045314, -0.0049437, -0.0052202, -0.0053829, -0.0053853, -0.0052314, -0.005022, -0.0048361, -0.0046416, -0.0045412, -0.0044932, -0.0044735, -0.0044622, -0.0044518 ]

    # create a custom coefficient object and return this
    c = PJScoefs( freq[idx], 1/freq[idx], Mh[idx], e0[idx], e1[idx], e2[idx], e3[idx], b3[idx], b4[idx], g1_0[idx], g1_1[idx], g1_2[idx], g1_3[idx], g1_4[idx], g2_0[idx], g2_1[idx], g2_2[idx], g2_3[idx], g2_4[idx], d1_0_0[idx], d1_0_1[idx], d1_0_2[idx], d1_1_0[idx], d1_1_1[idx], d1_1_2[idx], d1_2_0[idx], d1_2_1[idx], d1_2_2[idx], d1_3_0[idx], d1_3_1[idx], d1_3_2[idx], d2_0_0[idx], d2_0_1[idx], d2_0_2[idx], d2_1_0[idx], d2_1_1[idx], d2_1_2[idx], d2_2_0[idx], d2_2_1[idx], d2_2_2[idx], d2_3_0[idx], d2_3_1[idx], d2_3_2[idx], d3_0_0[idx], d3_0_1[idx], d3_0_2[idx], d3_1_0[idx], d3_1_1[idx], d3_1_2[idx], d3_2_0[idx], d3_2_1[idx], d3_2_2[idx], d3_3_0[idx], d3_3_1[idx], d3_3_2[idx], d4_0_0[idx], d4_0_1[idx], d4_0_2[idx], d4_1_0[idx], d4_1_1[idx], d4_1_2[idx], d4_2_0[idx], d4_2_1[idx], d4_2_2[idx], d4_3_0[idx], d4_3_1[idx], d4_3_2[idx], γCalifornia[idx] )

    return c
end

idx = 3
c = PJSgetCoefficients(idx)
c.T
c.Mh
c.e0
c.γCalifornia


function PJSmagnitude(m, c::PJScoefs)
    if m <= c.Mh
        F_M = c.e0 + c.e1 * (m - c.Mh) + c.e2 * (m - c.Mh)^2
    else
        F_M = c.e0 + c.e3 * (m - c.Mh)
    end
    return F_M
end

function PJSstressDrop(m, Δσ, c::PJScoefs)
    e_Δσ1 = c.g1_0 + c.g1_1 * m + c.g1_2 * m^2 + c.g1_3 * m^3 + c.g1_4 * m^4
    e_Δσ2 = c.g2_0 + c.g2_1 * m + c.g2_2 * m^2 + c.g2_3 * m^3 + c.g2_4 * m^4

    e_Δσ0 = -2.0 * e_Δσ1 - 4.0 * e_Δσ2

    F_Δσ = e_Δσ0 + e_Δσ1 * log10(Δσ) + e_Δσ2 * log10(Δσ)^2
    return F_Δσ
end

function PJSsource(m, Δσ, c::PJScoefs)
    F_M = PJSmagnitude(m, c)
    F_Δσ = PJSstressDrop(m, Δσ, c)
    return F_M + F_Δσ
end


mi = linspace(3, 9.6, 34)

Tj = [ 0.0, 0.2, 1.0, 10.0 ]

F_Mi_Tj = zeros(length(mi), length(Tj))

j = 2
for j in 1:length(Tj)
    idx = PJSgetCoefficientIndex(Tj[j])
    if idx[2] == false
        c = PJSgetCoefficients(idx[1][1])
    else
        clo = PJSgetCoefficients(idx[1][1])
        chi = PJSgetCoefficients(idx[1][2])
    end
    for i in 1:length(mi)
        if idx[2] == false
            F_Mi_Tj[i,j] = PJSmagnitude(mi[i], c)
        else
            F_M_Tlo = PJSmagnitude(mi[i], clo)
            F_M_Thi = PJSmagnitude(mi[i], chi)
            F_Mi_Tj[i,j] = F_M_Tlo + (F_M_Thi - F_M_Tlo) * log(Tj[j] / clo.T) / log(chi.T / clo.T)
        end
    end
end

plot(mi, F_Mi_Tj[:,1], marker=:circle, lab="PGA", ylim=[-2,6])
plot!(mi, F_Mi_Tj[:,2], marker=:circle, lab="5.0 Hz")
plot!(mi, F_Mi_Tj[:,3], marker=:circle, lab="1.0 Hz")
plot!(mi, F_Mi_Tj[:,4], marker=:circle, lab="0.1 Hz")
xlabel!("M")
ylabel!("F_M(log10) (cm/s^2)")


Δσi = logspace(log10(10.0), log10(2e3), 41)
mj = linspace(3.0, 9.0, 4)
F_T0p2_Δσi_Mj = zeros(length(Δσi), length(mj))
F_T2p0_Δσi_Mj = zeros(length(Δσi), length(mj))

idxT0p2 = PJSgetCoefficientIndex(0.2)
idxT2p0 = PJSgetCoefficientIndex(2.0)
cT0p2lo = PJSgetCoefficients(idxT0p2[1][1])
cT0p2hi = PJSgetCoefficients(idxT0p2[1][2])
cT2p0lo = PJSgetCoefficients(idxT2p0[1][1])
cT2p0hi = PJSgetCoefficients(idxT2p0[1][2])

for j = 1:length(mj)
    for i = 1:length(Δσi)
        F_Δσ_M_T0p2lo = PJSstressDrop(mj[j], Δσi[i], cT0p2lo)
        F_Δσ_M_T0p2hi = PJSstressDrop(mj[j], Δσi[i], cT0p2hi)
        F_Δσ_M_T2p0lo = PJSstressDrop(mj[j], Δσi[i], cT2p0lo)
        F_Δσ_M_T2p0hi = PJSstressDrop(mj[j], Δσi[i], cT2p0hi)

        F_T0p2_Δσi_Mj[i,j] = F_Δσ_M_T0p2lo + (F_Δσ_M_T0p2hi - F_Δσ_M_T0p2lo) * log( 0.2 / cT0p2lo.T ) / log( cT0p2hi.T / cT0p2lo.T )

        F_T2p0_Δσi_Mj[i,j] = F_Δσ_M_T2p0lo + (F_Δσ_M_T2p0hi - F_Δσ_M_T2p0lo) * log( 2.0 / cT2p0lo.T ) / log( cT2p0hi.T / cT2p0lo.T )
    end
end


pl = plot(Δσi, F_T2p0_Δσi_Mj[:,1], marker=:circle, lab="M 3", ylim=[-1,1], xaxis=:log10)
plot!(Δσi, F_T2p0_Δσi_Mj[:,2], marker=:circle, lab="M 5")
plot!(Δσi, F_T2p0_Δσi_Mj[:,3], marker=:circle, lab="M 7")
plot!(Δσi, F_T2p0_Δσi_Mj[:,4], marker=:circle, lab="M 9")
xlabel!("Δσ (bars)")
ylabel!("F_Δσ")
title!("0.5 Hz")


pr = plot(Δσi, F_T0p2_Δσi_Mj[:,1], marker=:circle, lab="M 3", ylim=[-1,1], xaxis=:log10)
plot!(Δσi, F_T0p2_Δσi_Mj[:,2], marker=:circle, lab="M 5")
plot!(Δσi, F_T0p2_Δσi_Mj[:,3], marker=:circle, lab="M 7")
plot!(Δσi, F_T0p2_Δσi_Mj[:,4], marker=:circle, lab="M 9")
xlabel!("Δσ (bars)")
ylabel!("F_Δσ")
title!("5.0 Hz")

plot(pl,pr,layout=(1,2))


function PJSkappa(κ0, m, Δσ, c::PJScoefs)
    # Compute the stress drop dependent coefficients pi,j
    # these are for i=1-4, and j=0-3
    logκ = log10(κ0)
    logM = log10(m)
    logΔσ = log10(Δσ)
    # i = 1, j = 0-3
    p1_0 = c.d1_0_0 + c.d1_0_1 * logΔσ + c.d1_0_2 * logΔσ^2
    p1_1 = c.d1_1_0 + c.d1_1_1 * logΔσ + c.d1_1_2 * logΔσ^2
    p1_2 = c.d1_2_0 + c.d1_2_1 * logΔσ + c.d1_2_2 * logΔσ^2
    p1_3 = c.d1_3_0 + c.d1_3_1 * logΔσ + c.d1_3_2 * logΔσ^2
    # i = 2, j = 0-3
    p2_0 = c.d2_0_0 + c.d2_0_1 * logΔσ + c.d2_0_2 * logΔσ^2
    p2_1 = c.d2_1_0 + c.d2_1_1 * logΔσ + c.d2_1_2 * logΔσ^2
    p2_2 = c.d2_2_0 + c.d2_2_1 * logΔσ + c.d2_2_2 * logΔσ^2
    p2_3 = c.d2_3_0 + c.d2_3_1 * logΔσ + c.d2_3_2 * logΔσ^2
    # i = 3, j = 0-3
    p3_0 = c.d3_0_0 + c.d3_0_1 * logΔσ + c.d3_0_2 * logΔσ^2
    p3_1 = c.d3_1_0 + c.d3_1_1 * logΔσ + c.d3_1_2 * logΔσ^2
    p3_2 = c.d3_2_0 + c.d3_2_1 * logΔσ + c.d3_2_2 * logΔσ^2
    p3_3 = c.d3_3_0 + c.d3_3_1 * logΔσ + c.d3_3_2 * logΔσ^2
    # i = 3, j = 0-3
    p4_0 = c.d4_0_0 + c.d4_0_1 * logΔσ + c.d4_0_2 * logΔσ^2
    p4_1 = c.d4_1_0 + c.d4_1_1 * logΔσ + c.d4_1_2 * logΔσ^2
    p4_2 = c.d4_2_0 + c.d4_2_1 * logΔσ + c.d4_2_2 * logΔσ^2
    p4_3 = c.d4_3_0 + c.d4_3_1 * logΔσ + c.d4_3_2 * logΔσ^2

    # Compute the magnitude dependent kappa coefficients
    e_κ01 = p1_0 + p1_1 * logM + p1_2 * logM^2 + p1_3 * logM^3
    e_κ02 = p2_0 + p2_1 * logM + p2_2 * logM^2 + p2_3 * logM^3
    e_κ03 = p3_0 + p3_1 * logM + p3_2 * logM^2 + p3_3 * logM^3
    e_κ04 = p4_0 + p4_1 * logM + p4_2 * logM^2 + p4_3 * logM^3
    e_κ00 = 3.0 * e_κ01 - 9.0 * e_κ02 + 27.0 * e_κ03 - 81.0 * e_κ04

    # Compute the kappa scaling factor
    F_κ0 = e_κ00 + e_κ01 * logκ + e_κ02 * logκ^2 + e_κ03 * logκ^3 + e_κ04 * logκ^4

    return F_κ0
end


# note that r is Rrup
function PJSgeometric(r, m, c::PJScoefs, cg::PJSgeometricCoefs)
    h = 10^(-0.405 + 0.235 * m)
    R = sqrt( r^2 + h^2 )
    Rref = sqrt( 1.0 + h^2 )

    # generic geometric spreading for Fourier ordinates
    if R <= cg.Rt
        Z = R^cg.b1
    else
        Z = cg.Rt^cg.b1 * ( R/cg.Rt ) ^ cg.b2
    end

    # Add the magnitude dependent geoemtric spreading
    F_Z = log10(Z) + (c.b3 + c.b4 * m) * log10( R / Rref )
    return F_Z
end

function PJSanelastic(r, c::PJScoefs)
    F_γ = c.γCalifornia * r
    return F_γ
end

function PJSpath(r, m, c::PJScoefs, cg::PJSgeometricCoefs)
    F_Z = PJSgeometric(r, m, c, cg)
    F_γ = PJSanelastic(r, c)
    return F_Z + F_γ
end


PJSpath(10.0, 5.0, c, cg)


# function PJSsite()
#     fi = [ 0.01, 0.02, 0.0]
#
# end


function PJSha2018known(m, r, Δσ, κ0, c::PJScoefs, cg::PJSgeometricCoefs)
    F_E = PJSsource(m, Δσ, c)
    F_κ = PJSkappa(κ0, m, Δσ, c)
    F_P = PJSpath(r, m, c, cg)
    logY = F_E + F_κ + F_P
    return 10^logY
end

function PJSha2018(T, m, r, Δσ, κ0, cg::PJSgeometricCoefs)
    # F_E + F_kappa + F_Z + F_gamma
    cg = PJSgeometricCoefs(50.0, -1.3, -0.5)
    cidx = PJSgetCoefficientIndex(T)
    if cidx[2] == false
        # no interpolation required
        c = PJSgetCoefficients(cidx[1][1])
        return PJSha2018known(m, r, Δσ, κ0, c, cg)
    else
        # interpolation required
        clo = PJSgetCoefficients(cidx[1][1])
        chi = PJSgetCoefficients(cidx[1][2])
        Ylo = PJSha2018known(m, r, Δσ, κ0, clo, cg)
        Yhi = PJSha2018known(m, r, Δσ, κ0, chi, cg)
        logY = log10(Ylo) + log10(Yhi / Ylo) * log10( T / clo.T ) / log10( chi.T / clo.T )
        return 10^logY
    end
end

fi = logspace(-1,2,101)

r = 1.0
Δσ = 100.0

m = 3.0
Sa_M3_κ1 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.001, cg), fi )
Sa_M3_κ2 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.005, cg), fi )
Sa_M3_κ3 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.010, cg), fi )
Sa_M3_κ4 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.030, cg), fi )
Sa_M3_κ5 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.050, cg), fi )
Sa_M3_κ6 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.100, cg), fi )
Sa_M3_κ7 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.150, cg), fi )

m = 5.0
Sa_M5_κ1 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.001, cg), fi )
Sa_M5_κ2 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.005, cg), fi )
Sa_M5_κ3 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.010, cg), fi )
Sa_M5_κ4 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.030, cg), fi )
Sa_M5_κ5 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.050, cg), fi )
Sa_M5_κ6 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.100, cg), fi )
Sa_M5_κ7 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.150, cg), fi )

m = 7.0
Sa_M7_κ1 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.001, cg), fi )
Sa_M7_κ2 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.005, cg), fi )
Sa_M7_κ3 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.010, cg), fi )
Sa_M7_κ4 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.030, cg), fi )
Sa_M7_κ5 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.050, cg), fi )
Sa_M7_κ6 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.100, cg), fi )
Sa_M7_κ7 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.150, cg), fi )

m = 9.0
Sa_M9_κ1 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.001, cg), fi )
Sa_M9_κ2 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.005, cg), fi )
Sa_M9_κ3 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.010, cg), fi )
Sa_M9_κ4 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.030, cg), fi )
Sa_M9_κ5 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.050, cg), fi )
Sa_M9_κ6 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.100, cg), fi )
Sa_M9_κ7 = map( x -> PJSha2018(1/x, m, r, Δσ, 0.150, cg), fi )


p1 = plot(fi, Sa_M3_κ1, lab="κ0 = 0.001", ylim=[0.001,1e3], yaxis=:log10, xaxis=:log10)
plot!(fi, Sa_M3_κ2, lab="κ0 = 0.005")
plot!(fi, Sa_M3_κ3, lab="κ0 = 0.010")
plot!(fi, Sa_M3_κ4, lab="κ0 = 0.030")
plot!(fi, Sa_M3_κ5, lab="κ0 = 0.050")
plot!(fi, Sa_M3_κ6, lab="κ0 = 0.100")
plot!(fi, Sa_M3_κ7, lab="κ0 = 0.150")
xlabel!("Frequency (Hz)")
ylabel!("PSA (cm/s^2)")
title!("M 3, Drup = 1km, Δσ = 100 bars")

p2 = plot(fi, Sa_M5_κ1, lab="κ0 = 0.001", ylim=[0.001,1e3], yaxis=:log10, xaxis=:log10)
plot!(fi, Sa_M5_κ2, lab="κ0 = 0.005")
plot!(fi, Sa_M5_κ3, lab="κ0 = 0.010")
plot!(fi, Sa_M5_κ4, lab="κ0 = 0.030")
plot!(fi, Sa_M5_κ5, lab="κ0 = 0.050")
plot!(fi, Sa_M5_κ6, lab="κ0 = 0.100")
plot!(fi, Sa_M5_κ7, lab="κ0 = 0.150")
xlabel!("Frequency (Hz)")
ylabel!("PSA (cm/s^2)")
title!("M 5, Drup = 1km, Δσ = 100 bars")

p3 = plot(fi, Sa_M7_κ1, lab="κ0 = 0.001", ylim=[0.001,1e3], yaxis=:log10, xaxis=:log10)
plot!(fi, Sa_M7_κ2, lab="κ0 = 0.005")
plot!(fi, Sa_M7_κ3, lab="κ0 = 0.010")
plot!(fi, Sa_M7_κ4, lab="κ0 = 0.030")
plot!(fi, Sa_M7_κ5, lab="κ0 = 0.050")
plot!(fi, Sa_M7_κ6, lab="κ0 = 0.100")
plot!(fi, Sa_M7_κ7, lab="κ0 = 0.150")
xlabel!("Frequency (Hz)")
ylabel!("PSA (cm/s^2)")
title!("M 7, Drup = 1km, Δσ = 100 bars")

p4 = plot(fi, Sa_M9_κ1, lab="κ0 = 0.001", ylim=[0.001,1e3], yaxis=:log10, xaxis=:log10)
plot!(fi, Sa_M9_κ2, lab="κ0 = 0.005")
plot!(fi, Sa_M9_κ3, lab="κ0 = 0.010")
plot!(fi, Sa_M9_κ4, lab="κ0 = 0.030")
plot!(fi, Sa_M9_κ5, lab="κ0 = 0.050")
plot!(fi, Sa_M9_κ6, lab="κ0 = 0.100")
plot!(fi, Sa_M9_κ7, lab="κ0 = 0.150")
xlabel!("Frequency (Hz)")
ylabel!("PSA (cm/s^2)")
title!("M 9, Drup = 1km, Δσ = 100 bars")

plot(p1,p2,p3,p4, layout=(2,2))

function PJSsite(T)
    freq = [ 0.010, 0.015, 0.021, 0.031, 0.045, 0.065, 0.095, 0.138, 0.200, 0.291, 0.423, 0.615, 0.894, 1.301, 1.892, 2.751, 4.000, 5.817, 8.459, 12.301, 17.889, 26.014, 37.830, 55.012, 80.000, 100.000 ]
    amp = [ 1.00, 1.01, 1.02, 1.02, 1.04, 1.06, 1.09, 1.13, 1.18, 1.25, 1.32, 1.41, 1.51, 1.64, 1.80, 1.99, 2.18, 2.38, 2.56, 2.75, 2.95, 3.17, 3.42, 3.68, 3.96, 3.96 ]
    knots = (freq,)
    itp = interpolate(knots, amp, Gridded(Linear()))
    return itp[1.0./T]
end

PJSsite(0.1)

plot(freq,amp, xaxis=:log10)
plot!(fi, PJSsite(1./fi), lab="interp")


function PJSya2015Δσ( m, z_hyp::Float64=10.0 )
    a0 = 2.18
    a1 = max(0.06, 0.3-0.04*m)
    log10_Δσ = a0 + min(0,a1*(z_hyp-12))
    Δσ = 10^log10_Δσ
    return Δσ
end

PJSya2015Δσ(6)

function PJSha2018Δσ( m )
    if m <= 4
        Δσ = 30.0
    elseif m >= 5
        Δσ = 75.0
    else
        Δσ = 30.0 + (75.0 - 30.0) * (m - 4.0)
    end
    return Δσ
end

PJSha2018Δσ(6)

mi = linspace(3.0, 8.0, 51)

Δσ_ya15_z04 = map( m -> PJSya2015Δσ(m, 4.0), mi )
Δσ_ya15_z08 = map( m -> PJSya2015Δσ(m, 8.0), mi )
Δσ_ya15_z12 = map( m -> PJSya2015Δσ(m, 12.0), mi )
Δσ_ha18 = map( m -> PJSha2018Δσ(m), mi )

plot(mi, Δσ_ya15_z04, lab="YA15 : z4km", yaxis=:log10)
plot!(mi, Δσ_ya15_z08, lab="YA15 : z8km")
plot!(mi, Δσ_ya15_z12, lab="YA15 : z12km")
plot!(mi, Δσ_ha18, lab="HA18")
xlabel!("M")
ylabel!("Δσ")



function PJSha2018cal(T, m, r)
    # F_E + F_kappa + F_Z + F_gamma
    C = 0.55
    κ0 = 0.04
    Δσ = PJSha2018Δσ(m)
    cg = PJSgeometricCoefs(50.0, -1.3, -0.5)
    cidx = PJSgetCoefficientIndex(T)
    if cidx[2] == false
        # no interpolation required
        c = PJSgetCoefficients(cidx[1][1])
        Yref = PJSha2018known(m, r, Δσ, κ0, c, cg)
    else
        # interpolation required
        clo = PJSgetCoefficients(cidx[1][1])
        chi = PJSgetCoefficients(cidx[1][2])
        Ylo = PJSha2018known(m, r, Δσ, κ0, clo, cg)
        Yhi = PJSha2018known(m, r, Δσ, κ0, chi, cg)
        logY = log10(Ylo) + log10(Yhi / Ylo) * log10( T / clo.T ) / log10( chi.T / clo.T )
        Yref = 10^logY
    end
    if isapprox(T, -1.0)
        F_S = 0.36
        Y = Yref * 10^F_S * 10^C
        return Y
    elseif isapprox(T, 0.0) || T < 0.01
        F_S = 0.47
        Y = Yref * 10^F_S * 10^C
        return Y/980.665
    else
        Y = Yref * PJSsite(T) * 10^C
        return Y/980.665
    end
end


function PJSha2018cal(T, m, r, Δσ, κ0)
    # F_E + F_kappa + F_Z + F_gamma
    C = 0.55
    cg = PJSgeometricCoefs(50.0, -1.3, -0.5)
    cidx = PJSgetCoefficientIndex(T)
    if cidx[2] == false
        # no interpolation required
        c = PJSgetCoefficients(cidx[1][1])
        Yref = PJSha2018known(m, r, Δσ, κ0, c, cg)
    else
        # interpolation required
        clo = PJSgetCoefficients(cidx[1][1])
        chi = PJSgetCoefficients(cidx[1][2])
        Ylo = PJSha2018known(m, r, Δσ, κ0, clo, cg)
        Yhi = PJSha2018known(m, r, Δσ, κ0, chi, cg)
        logY = log10(Ylo) + log10(Yhi / Ylo) * log10( T / clo.T ) / log10( chi.T / clo.T )
        Yref = 10^logY
    end
    if isapprox(T, -1.0)
        F_S = 0.36
        Y = Yref * 10^F_S * 10^C
        return Y
    elseif isapprox(T, 0.0) || T < 0.01
        F_S = 0.47
        Y = Yref * 10^F_S * 10^C
        return Y/980.665
    else
        Y = Yref * PJSsite(T) * 10^C
        return Y/980.665
    end
end


# Compare Hassani & Atkinson 2018 - with linear site response to Chiou & Youngs 2014
include("PJSchiouYoungs2014.jl")

Ti = logspace(-2,1,101)

rrup = 100.0

Sa_M5_R10_Δσ100 = map(x -> PJSha2018cal(x, 5.0, rrup), Ti)
Sa_M6_R10_Δσ100 = map(x -> PJSha2018cal(x, 6.0, rrup), Ti)
Sa_M7_R10_Δσ100 = map(x -> PJSha2018cal(x, 7.0, rrup), Ti)
Sa_M8_R10_Δσ100 = map(x -> PJSha2018cal(x, 8.0, rrup), Ti)

Sa_M5_R10_cy = map(x -> PJScy2014(x, 5.0, rrup, rrup, rrup, 0.0, 90.0, 0, 0, 0, 760.0, 1).Sa, Ti)
Sa_M6_R10_cy = map(x -> PJScy2014(x, 6.0, rrup, rrup, rrup, 0.0, 90.0, 0, 0, 0, 760.0, 1).Sa, Ti)
Sa_M7_R10_cy = map(x -> PJScy2014(x, 7.0, rrup, rrup, rrup, 0.0, 90.0, 0, 0, 0, 760.0, 1).Sa, Ti)
Sa_M8_R10_cy = map(x -> PJScy2014(x, 8.0, rrup, rrup, rrup, 0.0, 90.0, 0, 0, 0, 760.0, 1).Sa, Ti)

plot(Ti, Sa_M5_R10_Δσ100, color=:blue, lab="M 5 : HA18", xaxis=:log10, yaxis=:log10)
plot!(Ti, Sa_M5_R10_cy, color=:blue, linestyle=:dash, lab="M 5 : CY14")
plot!(Ti, Sa_M6_R10_Δσ100, color=:black, lab="M 6 : HA18")
plot!(Ti, Sa_M6_R10_cy, color=:black, linestyle=:dash, lab="M 6 : CY14")
plot!(Ti, Sa_M7_R10_Δσ100, color=:red, lab="M 7 : HA18")
plot!(Ti, Sa_M7_R10_cy, color=:red, linestyle=:dash, lab="M 7 : CY14")
plot!(Ti, Sa_M8_R10_Δσ100, color=:orange, lab="M 8 : HA18")
plot!(Ti, Sa_M8_R10_cy, color=:orange, linestyle=:dash, lab="M 8 : CY14")
xlabel!("Period (s)")
ylabel!("Spectral acceleration (g)")
savefig("figures/PJScompare_CY14_HA18_v0.pdf")


PJSha2018cal(0.0, 5.0, rrup, 100.0)
PJSha2018cal(0.01, 5.0, rrup, 100.0)


Ti = logspace(-2,1,101)

rrup = 100.0

# κ0 of 0.05, 0.03, 0.01
κ01 = 0.05
κ02 = 0.03
κ03 = 0.01
# Δσ of 40, 80, 160
Δσ1 = 40.0
Δσ2 = 80.0
Δσ3 = 160.0

Sa_M5_Δσ1_κ02 = map(x -> PJSha2018cal(x, 5.0, rrup, Δσ1, κ02), Ti)
Sa_M5_Δσ2_κ02 = map(x -> PJSha2018cal(x, 5.0, rrup, Δσ2, κ02), Ti)
Sa_M5_Δσ3_κ02 = map(x -> PJSha2018cal(x, 5.0, rrup, Δσ3, κ02), Ti)
Sa_M6_Δσ1_κ02 = map(x -> PJSha2018cal(x, 6.0, rrup, Δσ1, κ02), Ti)
Sa_M6_Δσ2_κ02 = map(x -> PJSha2018cal(x, 6.0, rrup, Δσ2, κ02), Ti)
Sa_M6_Δσ3_κ02 = map(x -> PJSha2018cal(x, 6.0, rrup, Δσ3, κ02), Ti)
Sa_M7_Δσ1_κ02 = map(x -> PJSha2018cal(x, 7.0, rrup, Δσ1, κ02), Ti)
Sa_M7_Δσ2_κ02 = map(x -> PJSha2018cal(x, 7.0, rrup, Δσ2, κ02), Ti)
Sa_M7_Δσ3_κ02 = map(x -> PJSha2018cal(x, 7.0, rrup, Δσ3, κ02), Ti)

Sa_M5_Δσ2_κ01 = map(x -> PJSha2018cal(x, 5.0, rrup, Δσ2, κ01), Ti)
Sa_M5_Δσ2_κ02 = map(x -> PJSha2018cal(x, 5.0, rrup, Δσ2, κ02), Ti)
Sa_M5_Δσ2_κ03 = map(x -> PJSha2018cal(x, 5.0, rrup, Δσ2, κ03), Ti)
Sa_M6_Δσ2_κ01 = map(x -> PJSha2018cal(x, 6.0, rrup, Δσ2, κ01), Ti)
Sa_M6_Δσ2_κ02 = map(x -> PJSha2018cal(x, 6.0, rrup, Δσ2, κ02), Ti)
Sa_M6_Δσ2_κ03 = map(x -> PJSha2018cal(x, 6.0, rrup, Δσ2, κ03), Ti)
Sa_M7_Δσ2_κ01 = map(x -> PJSha2018cal(x, 7.0, rrup, Δσ2, κ01), Ti)
Sa_M7_Δσ2_κ02 = map(x -> PJSha2018cal(x, 7.0, rrup, Δσ2, κ02), Ti)
Sa_M7_Δσ2_κ03 = map(x -> PJSha2018cal(x, 7.0, rrup, Δσ2, κ03), Ti)


pl = plot(Ti, Sa_M5_Δσ1_κ02, seriescolor=:blue, linestyle=:dash, lab="M 5, Δσ 40", xaxis=:log10, yaxis=:log10)
plot!(Ti, Sa_M5_Δσ2_κ02, seriescolor=:blue, linestyle=:solid, lab="M 5, Δσ 80")
plot!(Ti, Sa_M5_Δσ3_κ02, seriescolor=:blue, linestyle=:dashdot, lab="M 5, Δσ 160")
plot!(Ti, Sa_M6_Δσ1_κ02, seriescolor=:black, linestyle=:solid, lab="M 6, Δσ 40")
plot!(Ti, Sa_M6_Δσ2_κ02, seriescolor=:black, linestyle=:solid, lab="M 6, Δσ 80")
plot!(Ti, Sa_M6_Δσ3_κ02, seriescolor=:black, linestyle=:dashdot, lab="M 6, Δσ 160")
plot!(Ti, Sa_M7_Δσ1_κ02, seriescolor=:red, linestyle=:solid, lab="M 7, Δσ 40")
plot!(Ti, Sa_M7_Δσ2_κ02, seriescolor=:red, linestyle=:solid, lab="M 7, Δσ 80")
plot!(Ti, Sa_M7_Δσ3_κ02, seriescolor=:red, linestyle=:dashdot, lab="M 7, Δσ 160")
xlabel!("Period (s)")
ylabel!("Spectral acceleration (g)")

pr = plot(Ti, Sa_M5_Δσ2_κ01, seriescolor=:blue, linestyle=:dash, lab="M 5, κ0 0.05", xaxis=:log10, yaxis=:log10)
plot!(Ti, Sa_M5_Δσ2_κ02, seriescolor=:blue, linestyle=:solid, lab="M 5, κ0 0.03")
plot!(Ti, Sa_M5_Δσ2_κ03, seriescolor=:blue, linestyle=:dashdot, lab="M 5, κ0 0.01")
plot!(Ti, Sa_M6_Δσ2_κ01, seriescolor=:black, linestyle=:solid, lab="M 6, κ0 0.05")
plot!(Ti, Sa_M6_Δσ2_κ02, seriescolor=:black, linestyle=:solid, lab="M 6, κ0 0.03")
plot!(Ti, Sa_M6_Δσ2_κ03, seriescolor=:black, linestyle=:dashdot, lab="M 6, κ0 0.01")
plot!(Ti, Sa_M7_Δσ2_κ01, seriescolor=:red, linestyle=:solid, lab="M 7, κ0 0.05")
plot!(Ti, Sa_M7_Δσ2_κ02, seriescolor=:red, linestyle=:solid, lab="M 7, κ0 0.03")
plot!(Ti, Sa_M7_Δσ2_κ03, seriescolor=:red, linestyle=:dashdot, lab="M 7, κ0 0.01")
xlabel!("Period (s)")
ylabel!("Spectral acceleration (g)")

plot(pl,pr, layout=(1,2))
savefig("figures/PJSparameterVariations_HA18_v0.pdf")


Sa_M6_R10_Δσ100 = map(x -> PJSha2018cal(x, 6.0, rrup), Ti)
Sa_M7_R10_Δσ100 = map(x -> PJSha2018cal(x, 7.0, rrup), Ti)
Sa_M8_R10_Δσ100 = map(x -> PJSha2018cal(x, 8.0, rrup), Ti)
